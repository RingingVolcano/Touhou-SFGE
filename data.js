const main = {
  title: '【2021·东方华灯宴】',
  aid: '799209582',
  bvid: 'BV1Sy4y1Y773',
  pages: [
    {
      title: 'P1 牛年开气运',
      endTime: '66:12',
    },
    {
      title: 'P2 转念聚吉祥',
      endTime: '81:33',
    },
    {
      title: 'P3 乾道同和乐',
      endTime: '79:07',
    },
    {
      title: 'P4 坤仪美景长',
      endTime: '98:32',
    },
  ],
}
const prefix = `https://www.bilibili.com/video/`
const data = [
  {
    time: '00:00',
    page: 1,
    title: '射命丸',
  },
  {
    time: '02:44',
    page: 1,
    title: '开宴「流光惊鸿」',
  },
  {
    time: '11:51',
    page: 1,
    title: '开场动画',
  },
  {
    time: '12:53',
    page: 1,
    title: '主持1 - 灵梦, 魔理沙',
  },
  {
    time: '13:31',
    page: 1,
    title: '广告环节',
  },
  {
    time: '14:47',
    page: 1,
    title: '主持2 - 灵梦, 魔理沙',
  },
  {
    time: '16:12',
    page: 1,
    title: '东方名曲发生了奇怪的BUG',
  },
  {
    time: '23:07',
    page: 1,
    title: '生与死的境界',
  },
  {
    time: '33:05',
    page: 1,
    title: '嘉宾祝福1',
  },
  {
    time: '38:14',
    page: 1,
    title: 'R.I.P.――Rest In Peace',
  },
  {
    time: '41:37',
    page: 1,
    title: '东方夜明歌',
    aid: '331675871',
    bvid: 'BV1RA411T7E9',
  },
  {
    time: '48:36',
    page: 1,
    title: '主持3 - 小铃, 早苗',
  },
  {
    time: '49:54',
    page: 1,
    title: '学漫才',
  },
  {
    time: '00:00',
    page: 2,
    title: '主持4 - 灵梦, 魔理沙, 小铃, 早苗',
  },
  {
    time: '01:43',
    page: 2,
    title: '东方Project ~家庭教师~',
  },
  {
    time: '06:49',
    page: 2,
    title: '爱丽丝梦游仙境',
  },
  {
    time: '11:53',
    page: 2,
    title: '乱斗60秒: 十六夜 vs DIO',
  },
  {
    time: '15:34',
    page: 2,
    title: '闻鸡起舞的凭依华捣蒜',
  },
  {
    time: '19:39',
    page: 2,
    title: '嘉宾祝福2',
  },
  {
    time: '23:22',
    page: 2,
    title: '幻想乡打牌王',
  },
  {
    time: '53:14',
    page: 2,
    title: '主持5 - 小铃, 早苗',
  },
  {
    time: '54:34',
    page: 2,
    title: '人相「造型术」',
  },
  {
    time: '58:36',
    page: 2,
    title: '幻想游戏<花映塚连弹>',
  },
  {
    time: '67:46',
    page: 2,
    title: '对坐数来宝',
  },
  {
    time: '74:27',
    page: 2,
    title: 'Daisuke',
  },
  {
    time: '77:12',
    page: 2,
    title: '红莲的夕岚',
  },
  {
    time: '00:00',
    page: 3,
    title: '幻葬梦华笺',
  },
  {
    time: '02:50',
    page: 3,
    title: '玄星 ~Hidden Stars~',
  },
  {
    time: '07:39',
    page: 3,
    title: '东游鉴的魔法书 ~新春特别篇~',
  },
  {
    time: '19:03',
    page: 3,
    title: '饵',
  },
  {
    time: '22:02',
    page: 3,
    title: '东方萃梦想',
  },
  {
    time: '27:34',
    page: 3,
    title: '「Chu♡Chu♡Chu」',
  },
  {
    time: '31:10',
    page: 3,
    title: '主持6 - 魔理沙',
  },
  {
    time: '32:54',
    page: 3,
    title: '红魔馆不能有两个门卫',
  },
  {
    time: '37:24',
    page: 3,
    title: '嘉宾祝福3',
  },
  {
    time: '41:22',
    page: 3,
    title: '高级餐厅',
  },
  {
    time: '51:59',
    page: 3,
    title: 'HAVE A NICE DAY',
  },
  {
    time: '56:37',
    page: 3,
    title: '流浪月球 II',
  },
  {
    time: '00:00',
    page: 4,
    title: 'ヲタ芸',
  },
  {
    time: '03:35',
    page: 4,
    title: '東方寶麗金: 歌行休回頭',
  },
  {
    time: '08:31',
    page: 4,
    title: '鬼王聚会',
  },
  {
    time: '16:44',
    page: 4,
    title: '请笃信一个梦',
  },
  {
    time: '21:29',
    page: 4,
    title: '嘉宾祝福4',
  },
  {
    time: '25:27',
    page: 4,
    title: '东方没嘻哈――灵梦vs八云紫',
  },
  {
    time: '29:17',
    page: 4,
    title: 'DUOLOGUE: A FRIDAY CHAT',
  },
  {
    time: '36:29',
    page: 4,
    title: '夙愿',
  },
  {
    time: '40:39',
    page: 4,
    title: '老腔皮影戏《东方非想天则》',
    aid: '416680994',
    bvid: 'BV1CV411i7G7',
  },
  {
    time: '66:03',
    page: 4,
    title: '无何有之乡',
  },
  {
    time: '71:12',
    page: 4,
    title: '挠痒痒地狱之刑',
  },
  {
    time: '75:07',
    page: 4,
    title: '华魂',
  },
  {
    time: '80:20',
    page: 4,
    title: '主持7 - 灵梦, 魔理沙, 小铃, 早苗',
  },
  {
    time: '82:36',
    page: 4,
    title: '结束动画',
  },
  {
    time: '95:09',
    page: 4,
    title: 'Staff表',
  },
]
const fs = require('fs')
const template = fs.readFileSync('template.md', { encoding: 'utf-8' })
const placeholder = '<!-- data -->'
const header = `
|节目|时间|时长|单品|
|----|----|----|----|
`.trim()
const getSeconds = time => {
  const [minutes, seconds] = time.split(':').map(it => parseInt(it))
  return minutes * 60 + seconds
}
const getTime = seconds => {
  return `${Math.trunc(seconds / 60).toString().padStart(2, '0')}:${(seconds % 60).toString().padStart(2, '0')}`
}
const table = data.map((item, index) => {
  const mainLink = (() => {
    if (item.time) {
      const page = item.page || 1
      return `| [${item.title}](${prefix}${main.bvid}?p=${page}&t=${getSeconds(item.time)}) `
    }
    return `| ${item.title} `
  })()
  const time = (() => {
    if (item.time) {
      const page = item.page || 1
      const hasNextItem = index !== data.length - 1 && data[index + 1].time && (data[index + 1].page || 1) === page
      if (hasNextItem) {
        const length = getTime(getSeconds(data[index + 1].time) - getSeconds(item.time))
        return `| ${item.time} ~ ${data[index + 1].time} | ${length} `
      }
      const endTime = main.pages[page - 1].endTime
      const length = getTime(getSeconds(endTime) - getSeconds(item.time))
      return `| ${item.time} ~ ${endTime} | ${length} `
    }
    return '| / '
  })()
  const single = (() => {
    if (item.aid && item.bvid) {
      return `| [av${item.aid}](${prefix}av${item.aid}) / [${item.bvid}](${prefix}${item.bvid}) `
    }
    return '| / '
  })()
  if (item.time === '00:00') {
    return `
## ${main.pages[item.page - 1].title}
${header}
${mainLink + time + single + '|'}`
  }
  return mainLink + time + single + '|'
}).join('\n')
fs.writeFileSync('README.md', template.replace(placeholder, table))
